---
title: "Dynamic Documents, R, and Markdown"
subtitle: "a key component of reproducible research"
author: "Keith P. Lewis"
date: "NAFC | Fisheries and Oceans Canada | 2017-11-26"
output: 
  ioslides_presentation:
    incremental: true
    widescreen: true
    logo: rmarkdown.png
---

```{r setup, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
knitr::opts_knit$set(root.dir = '../')
knitr::opts_chunk$set(cache = TRUE, 
                      fig.align = "center", 
                      fig.height = 4.5, 
                      fig.width = 7.5,
                      dev = "svg")
library(readr)
library(tidyr)
library(dplyr)
library(ggplot2)

# load the data
abiotic <- read_csv("../data/trawl_abiotic.csv", guess_max = 5000)
head(abiotic)

# modify the data
abiotic_abrev <- filter(abiotic, year < 2005)
```

## RStudio Tips
- Complie Notebook??
  
## Before we get started
- Could you click on File -> New -> RMarkdown?
- Got data sets, 
- packages knitr, kfigr, xtable, tidyverse

## Overview
- Reproducible Research (RR): reasons and benefits
- Dynamic Documents with RMarkdown
    - introduction 
    - basics
    - Workflows: What i've learned....so far
    - intermediate
    - advanced


## Reproducible Research (RR)
- Reproducibility is a cornerstone of science
- Reproducibility is increasingly difficult because of:
    - complex statistics
    - multiple authors/ increased collaboration
    - Big data: data decisions

## A graphical model for RR (Lewis et al. accepted) {.smaller}
<style> 
  #slideID > p { 
    margin-top: -100px; 
  } 
</style>
<img src="figures/5_open-science-model.png" width="80%" />

## Reproducible Research (RR)
- Reproducibility is a cornerstone of science
- Reproducibility is increasingly difficult because of:
    - complex statistics
    - multiple authors/ increased collaboration
    - Big data: data decisions
- Without the code and data, an analysis is not reproducible
- But how to make the document reproducible?

## RR with Dynamic Documents (DD)
- What is a dynamic document?
  - source document with program code and text
    - Minimizes cutting/pasting
    - links writing and analysis
- Word processing (WYSIWYG) v document preparation (WYSISYM)
  - Seperates writing from formatting
- Languages: e.g., Markdown, LaTeX (LyX)
- knitr (Yihui Xie)

## Benefits of RR with DD {.smaller}
- Idealistic: 
    - RR makes for better science (or helps prevents bad science)
    - see WSBpaper******
    - Analogy:
      - prevention ~ education
      - medication (traditional) ~  peer-review + editor
      - medication (modern) ~  peer-review + editor + RR
  
- Practical:
    - streamline workflow
    - rapidly update your own work
    - organize and retrieve analyses
    - rescue projects
    - improved collaboration and review of projects


## Objectives
- basic: produce a dynamic document (html, pdf, or Word) in Rmarkdown
- intermediate: make it pretty
- advanced: make it functional, i.e., fully reproducible

## RMarkdown: the basics
<style> 
  #slideID > p { 
    margin-top: -150px; 
  } 
</style>
<img src="figures/6_Rstudio_DD.png" width="95%" />

## RMarkdown: the basics of "chunks"
- The "r chunk"
- To start a r chunk type ```r{}
- To end a r chunk type ```
- The "text chunk" goes in between the r chunks
  - e.g. "In a hole in the ground there lived a hobbit....."

## Basic Exercises
Now, your turn:
- 1) read in the abiotic data file
- 2) filter out the years after 2005
- 3) begin an R markdown file
- 4) edit it to produce the example

## Workflow
<style> 
  #slideID > p { 
    margin-top: -50px; 
  } 
</style>
<img src="figures/1_generic_workflow.PNG" width="95%" />

## Workflow evolution 1
<style> 
  #slideID > p { 
    margin-top: -50px; 
  } 
</style>
<img src="figures/2_workflow_chaos.PNG" width="95%" />

## Workflow evolution 2
<style> 
  #slideID > p { 
    margin-top: -50px; 
  } 
</style>
<img src="figures/3_workflow_improvements.PNG" width="95%" />

## Workflow evolution 3
<style> 
  #slideID > p { 
    margin-top: -50px; 
  } 
</style>
<img src="figures/4_workflow_current_state.PNG" width="95%" />

## Intermediate RMarkdown - prettify the document
- Change the YAML header
- Add headers to the text
- Add a caption
- Control what to display

## RMarkdown: intermediate
<style> 
  #slideID > p { 
    margin-top: -100px; 
  } 
</style>
<img src="figures/6_Rstudio_DD.png" width="95%" />

## RMarkdown: intermediate "chunks"
- ```r{} starts the chunk
- ``` ends the chunk
- But you can add loads of stuff to r{}
  - Add a label and a caption - r{fig.cap = "the title"}
  - Control what to display
    - code r{echo = F}
    - warnings r{warnings = F}
    - messages r{messages = F}
    - results r{results = "hide"}

## Intermediate exercises
Copy the first exercise to a new file and produce the following document

## Advanced RMarkdown
- label a figure in the text, i.e., cross reference
- make a table 
- calculate a parameter and insert into text
- update the document

## Advanced RMarkdown: label a figure and make a table
- label: {r, "label of the figure", fig.cap = "blah, blah, blah"}

- embed label using R code in text ``` ``r "r some function(arguements)"`` ```
- hard code e.g. "blah, blah, blah (Fig. 1)"
- dynamic e.g. "blah, blah, blah ``` `figr('label', TRUE, type="Fig.")` ```

## Advanced RMarkdown: make the table
- Various package options (kable, xtable, stargazer)
- the steps:
  - create a summary first
  - wrap it the summary in xtable and make an object
  - print the table

## Advanced RMarkdown: calculate a parameter and insert into text
- embed R code in text `some function(arguements)`
- hard code e.g. "blah, blah, blah mean = 10, SD = 2"
- dynamic e.g. "blah, blah, blah mean= ``` `r mean(abiotic_abrev$depth)` ```
- dynamic and pretty e.g. "blah, blah, blah mean = ``` `r round(mean(abiotic_abrev$depth), 2)` ```

## Advanced exercises
- Copy the second exercise to a new file and produce the following document
- Hint: the summary is the mean and SD of depth by NAFO division - use the tidyverse
- tab <- xtable(the summary)
- print(tab, comment = F)


- .....then update it :)
  
## Next steps in RMarkdown
 - YAML headers
 - hooks
 - inserting graphics
 - Presentations (ioslides and RPres)
 - Posters (dashboard)
 - Adding bibliographies
 - templates
 - insert equations
 - Notebooks

## Help {.smaller}
Books
Xie, Y. 2013. Dynamic Documents with R and knitr. CRC Press, London.
Gandrud, C. 2014. Reproducible Research with R and RStudio. 2nd Edition. CRC Press, Boca Raton, FL. 

Cheatsheets
http://ropensci.github.io/reproducibility-guide/sections/introduction/
https://www.rstudio.com/wp-content/uploads/2015/03/rmarkdown-reference.pdf

Reproducible Research webpages
http://ropensci.github.io/reproducibility-guide/sections/introduction/

Knitr or Markdown webpages
https://yihui.name/knitr/
https://support.rstudio.com/hc/en-us/articles/205368677-R-Markdown-Dynamic-Documents-for-R
https://sachsmc.github.io/knit-git-markr-guide/knitr/knit.html
http://kbroman.org/knitr_knutshell/pages/Rmarkdown.html

YAML
http://rmarkdown.rstudio.com/html_document_format.html
http://rmarkdown.rstudio.com/pdf_document_format.html
http://rmarkdown.rstudio.com/word_document_format.html

## Sample document
- Zuur's Exploratory data analysis - put on Github

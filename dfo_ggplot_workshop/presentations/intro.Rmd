---
title: "Plotting in the tidyverse: ggplot2"
author: "Keith Lewis and Paul Regular"
date: "NAFC | Fisheries and Oceans Canada | October 12, 2017"
output: 
  ioslides_presentation:
    incremental: true
    widescreen: true
    logo: ggplot2_hex.png
---


```{r setup, echo=FALSE, results="hide", message=FALSE, warnings=FALSE}
library(knitr)
library(tidyr)
library(dplyr)
library(ggplot2)
library(cowplot)
suppressWarnings(library(plotly))
data(mtcars)
data(diamonds)
data(mpg)
knitr::opts_knit$set(root.dir = '../')
knitr::opts_chunk$set(cache = TRUE, 
                      fig.align = "center", 
                      fig.height = 4.5, 
                      fig.width = 7.5,
                      dev = "svg")
# 1. Introduction to ggplot ####
```


## Rstudio tips

- Arguements
    - `gather(data = dune_sp, key=species, value = "cover_class", Achimill:Callcusp)` or
    - `gather(dune_sp, species, "cover_class", Achimill:Callcusp)`
- Use the editor and pass to consol with Ctrl-Enter
- The cheatsheets

## Getting started 
Before we go:

1. Have you got R installed? 
2. Were you able to download the scripts and data we sent?
3. Does the following code run without errors? 

```{r startup, echo=TRUE, results='hide'}
# setwd("c:/where_the_folder_is/")

library(readr)
library(tidyr)
library(dplyr)

file.exists("data/mtcars.csv")
file.exists("data/diamonds.csv")
file.exists("data/trawl_abiotic.csv")
file.exists("data/trawl_biomass.csv")

```

## Outline

>- Plotting options
>- Grammar of graphics
>- ggplot2: the basics
>- ggplot2: intermediate
>- ggplot2: advanced stuff
>- Cookbook for R

## Plotting options

*"The greatest value of a picture is when it forces us to notice what we never expected to see."* â€” John Tukey

- spreadsheets, e.g., Excel (hint: it sucks!)
- stand alone program, e.g., Sigma Plot
- other stats programs, e.g., SAS
- R
    - base
    - various functions
    - ggplot2 (part of the tidyverse)

## Grammar of graphics

- layer
    - data
    - mappings (aesthetics)
    - geometry (points, lines, polygons)
    - statistics (binning)
    - position
- scales (colour, size, shape, axes)
- coordinates (e.g. Cartesian)
- faceting (multiple subsets; lattice)

## ggplot2: the basics

>- data (e.g. mtcars)
>- scatterplot
>- boxplot
>- stacked bar
>- saving the output
>- exercises

## ggplot2: the basics - data  {.smaller}

```{r}
str(mtcars)
mtcars$am <- as.factor(mtcars$am)
mtcars$cyl <- as.factor(mtcars$cyl)
```

## ggplot2: the basics - scatterplot

```{r}
ggplot(data = mtcars, aes(x = mpg, y = disp)) + geom_point()
```

## ggplot2: the basics - box-whisker plot

```{r}
ggplot(data = mtcars, aes(x = cyl, y = mpg)) + geom_boxplot()
```

## ggplot2: the basics - stacked bargraph

```{r}
ggplot(data = mtcars, aes(x = cyl, y = mpg, fill = am)) +
  geom_bar(stat = "identity") # statistics modifies geom
```

## ggplot2: the basics - saving the figure

```{r, eval=FALSE}
ggplot(data = mtcars, aes(x = cyl, y = mpg, fill = am)) +
  geom_bar(stat = "identity")
ggsave("plot.pdf")               # saves to working directory
```

## ggplot2: the basics - exercises

>- Load the trawl biomass data using readr.
>- Select year, trawl_id, and one species
>- Make a boxplot of biomass by year
>- save the file as a pdf

## ggplot2: intermediate

Move away from defaults to publication quality

- build upon an object
- change size, colour, and shape
- axes
- legends
- themes

## ggplot2: intermediate - make an object

```{r, fig.height=3.5, fig.width = 6.5}
p <- ggplot(data = mtcars, aes(x = mpg, y = disp))
p + geom_point()
```

## ggplot2: intermediate - object + more grammar

```{r, fig.height=3.5, fig.width = 6.5}
p <- ggplot(data = mtcars, aes(x = mpg, y = disp))
p + geom_point(shape = 20, size = 2.5, colour = "red")  # change the scales
```

## ggplot2: intermediate - object + more grammar {.smaller}

```{r, fig.height=3.5, fig.width = 6.5}
p <- ggplot(data = mtcars, aes(x = mpg, y = disp, colour = cyl))
p + geom_point(shape = 20, size = 2.5) +  # change the object
  ylab("Displacement (cu. in)") +         # change label of y-axis
  xlab("Miles per gallon") +              # change label of x-axis
  labs(fill = "Number of cylinders")      # change label of legend
```

## ggplot2: intermediate - object + more grammar {.smaller}

```{r, fig.height=3.5, fig.width = 6.5}
ggplot(data = mtcars, aes(x = cyl, y = mpg, fill = am)) +
  geom_bar(stat = "identity") +
  ylab("Number of cylinders") +
  xlab("Miles per gallon") +
  labs(fill = "Automatic/\nManual") +      # \n ~ "return"
  scale_fill_brewer(palette = "Pastel1") + # change bar colours
  theme_bw()                               # change theme
```

## ggplot2: intermediate - exercises

>- Use either the trawl abiotic or biomass data and create a chart
>- Then, make it publication quality (change the axis label, theme, etc.)
>- save it as a pdf or other file type

## ggplot2: advanced stuff

>- tidyverse & facets
>- working with layers - the true power of ggplot!

## ggplot2: advanced stuff - the tidyverse {.smaller}

```{r, fig.height=3.5, fig.width = 6.5}
diamonds %>%                  # Start with the 'diamonds' dataset
  filter(cut == "Ideal") %>%  # Then, filter down to rows where cut == Ideal
  ggplot(aes(price)) +        # Then, determine aes
    geom_histogram()          # plot histograms
```

## ggplot2: advanced stuff - tidyverse and facets {.smaller}

```{r, fig.height=3.5, fig.width = 6.5}
diamonds %>%                   # Start with the 'diamonds' dataset
  filter(cut == "Ideal") %>%   # Then, filter down to rows where cut == Ideal
  ggplot(aes(price)) +         # Then, determine aes
    geom_histogram() +         # plot histograms
    facet_wrap(~ color)        # in plots by 'color'
```

## ggplot2: advanced stuff - layers

```{r, fig.height=3.5, fig.width = 6.5}
# no layers
ggplot(data = diamonds, aes(x = carat, y = price, colour = cut)) # run this line - what happens?
```

## ggplot2: advanced stuff - layers {.smaller}

```{r, fig.height=3.5, fig.width = 6.5}
# one layer
ggplot(data = diamonds,               # the data and mapping/aesthetics
       aes(x = carat, y = price, colour = cut)) +
        geom_point()                  # the point layer

```

## ggplot2: advanced stuff - layers {.smaller}

```{r, fig.height=3.5, fig.width = 6.5}
# one layer but with data specific to layer
ggplot() +                              
  geom_point(data = diamonds,          # the data and mapping/aesthetics
             aes(x = carat, y = price, colour = cut))   # the point layer                                 
```

## ggplot2: advanced stuff - layers {.smaller}

```{r, fig.height=3.5, fig.width = 6.5}
# two layers
ggplot(data = diamonds, aes(x = carat, y = price, colour = cut)) +  # the data and mapping/aesthetics
  geom_point() +                                                    # the point layer
  geom_smooth()                                                     # the line layer
```

## ggplot2: advanced stuff - layers

Use Ale's example

## ggplot2: advanced stuff - exercises

>- Using the trawl data sets, use pipes to join the two data sets, modify the data, and make a figure with at least two layers

## More advanced, really cool stuff!!!!!!
>- interactive plots
>- multiple plots
>- maps

## ggplot2: advanced stuff - interactive plots

```{r}
p <- ggplot(data = mtcars, aes(x = mpg, y = disp, colour = cyl)) + geom_point()
ggplotly(p)
```

## ggplot2: advanced stuff - multiple plots

```{r}
p1 <- ggplot(data = mtcars, aes(x = mpg, y = disp)) + geom_point()
p2 <- ggplot(data = mtcars, aes(x = cyl, y = mpg)) + geom_boxplot()
plot_grid(p1, p2, labels = c("A", "B"))
```

## ggplot2: advanced stuff - maps

```{r}

```

## Help {.smaller}

Books on ggplot:

>- Chang, W. 2013. R Graphics Cookbook. O'Reilly
>- Wickham, H. 2009. ggplot2: elegant graphics for data analysis. Springer.

Theoretical foundation:

>- Tufte, E.R. The visual display of quantitative information.
>- Wilkinson, L. 2005. The grammar of graphics. Springer.

Websites:

>- http://www.cookbook-r.com/   [THIS IS GOLD!!!!!!!!]
>- http://ggplot.yhathq.com/
>- https://rpubs.com/hadley/ggplot2-layers [for understanding layers]
>- https://cran.r-project.org/web/packages/cowplot/vignettes/introduction.html

Papers:

>- Su, Y-S. 2008. It's easy to produce chartjunk using MS Excel 2007 but hard to make good graphs.  Computational Statistis and Data Anlaysis. 52: 4594-4601. https://rpubs.com/hadley/ggplot2-layers


---
title: "Plotting in the tidyverse: ggplot2"
author: "Keith Lewis and Paul Regular"
date: "NAFC | Fisheries and Oceans Canada | October 12, 2017"
output: 
  ioslides_presentation:
    incremental: true
    widescreen: true
    logo: ggplot2_hex.png
---


```{r setup, echo=FALSE, results="hide", message=FALSE}
library(knitr)
library(tidyr)
library(dplyr)
library(ggplot2)
knitr::opts_knit$set(root.dir = '../')
knitr::opts_chunk$set(cache = TRUE, 
                      fig.align = "center", 
                      fig.height = 4.5, 
                      fig.width = 7.5,
                      dev = "svg")
# 1. Introduction to ggplot ####
```


## Rstudio tips

- Arguements
    - `gather(data = dune_sp, key=species, value = "cover_class", Achimill:Callcusp)` or
    - `gather(dune_sp, species, "cover_class", Achimill:Callcusp)`
- Use the editor and pass to consol with Ctrl-Enter
- The cheatsheets

## Outline

>- Plotting options
>- Grammar of graphics
>- ggplot2: the basics
>- ggplot2: intermediate
>- ggplot2: advanced stuff
>- Cookbook for R

## Plotting options

*"The greatest value of a picture is when it forces us to notice what we never expected to see."* — John Tukey

- spreadsheets, e.g., Excel (hint: it sucks!)
- stand alone program, e.g., Sigma Plot
- other stats programs, e.g., SAS
- R
    - base
    - various functions
    - ggplot2 (part of the tidyverse)

## Grammar of graphics

- layer
    - data
    - mappings (aesthetics)
    - geometry (points, lines, polygons)
    - statistics (binning)
    - position
- scales (colour, size, shape, axes)
- coordinates (e.g. Cartesian)
- faceting (multiple subsets; lattice)

## ggplot2: the basics

>- data
>- scatterplot
>- boxplot
>- stacked bar
>- saving the output
>- exercises

## ggplot2: the basics - data {.build}

>- A prerequisite for plotting in R is reading your data into R

```{r, message=FALSE}

library(readr)
abiotic <- read_csv("data/trawl_abiotic.csv", guess_max = 5000)
head(abiotic)

```

## ggplot2: the basics - scatterplot  {.build}

```{r, warning=FALSE, fig.width=4.5}
ggplot(data = abiotic, aes(x = temp_bottom, y = depth)) + geom_point()
```

## ggplot2: the basics - box-whisker plot  {.build}

```{r, warning = FALSE}
ggplot(data = abiotic, aes(x = nafo_div, y = temp_bottom)) + geom_boxplot()
```

## ggplot2: the basics - stacked bargraph  {.build}

```{r}
ggplot(data = abiotic, aes(x = year, fill = nafo_div)) +
  geom_bar(stat = "count") # statistics modifies geom
```

## ggplot2: the basics - saving the figure 

```{r, eval=FALSE}
ggplot(data = abiotic, aes(x = year, fill = nafo_div)) +
  geom_bar(stat = "count")     # statistics modifies geom
ggsave("plot.pdf")             # saves to working directory
ggsave("plot.png", dpi = 600)
```

>- Easy to export publication quality vector (e.g. "pdf") or high-resolution raster (e.g. "png") figures


## ggplot2: the basics - exercises 

>- Load the trawl biomass data using readr
>- Replicate the plot below and save the file as a pdf

```{r, message=FALSE, echo=FALSE}
biomass <- read_csv("data/trawl_biomass.csv")
ggplot(data = biomass, aes(x = factor(year), y = shrimp)) + geom_boxplot()
```

## ggplot2: intermediate

Move away from defaults to publication quality

- build upon an object
- change size, colour, and shape
- axes
- legends
- themes

## ggplot2: intermediate - object + geom {.build}

```{r, fig.height=4.5, fig.width = 4, warning=FALSE}
p <- ggplot(data = abiotic)
p + geom_point(aes(x = temp_bottom, y = depth))
```

## ggplot2: intermediate - object + alternate aes {.build}

```{r, fig.height=4.5, fig.width = 4, warning=FALSE}
p + geom_point(aes(x = temp_bottom, y = depth, colour = nafo_div))
```

## ggplot2: intermediate - object + more grammar {.smaller .build}

```{r, fig.height=3.5, fig.width = 4, warning=FALSE}
p <- ggplot(data = abiotic, aes(x = temp_bottom, y = depth, colour = nafo_div))
p + geom_point(shape = 16, size = 1, alpha = 0.5) +  # change the geom
  ylab("Depth (m)") +                                # change label of y-axis
  xlab("Temperature (°C)") +                         # change label of x-axis
  labs(colour = "NAFO")                              # change label of legend
```

## ggplot2: intermediate - object + more grammar {.smaller .build}

```{r, fig.height=3.5, fig.width = 4, warning=FALSE}
p <- ggplot(data = abiotic, aes(x = temp_bottom, y = depth, colour = nafo_div))
p + geom_point(shape = 16, size = 1, alpha = 0.5) +                      # change the geom
  ylab("Depth (m)") + xlab("Temperature (°C)") + labs(colour = "NAFO") + # change labels
  scale_y_reverse(limits = c(750, 0)) +                                  # reverse y-axis and impose limits
  scale_x_continuous(position = "top") +                                 # place x-axis on top of plot
  scale_colour_brewer(palette = "Set1") +                                # change the colour palette
  theme_bw()                                                             # change the theme
```

## ggplot2: intermediate - exercises

>- Use either the trawl abiotic or biomass data and create a chart
>- Then, make it publication quality (change the axis label, theme, etc.)
>- save it as a pdf or other file type

## ggplot2: advanced stuff

>- tidyverse
>- facets
>- working with layers

## ggplot2: advanced stuff - the tidyverse {.smaller .build}

```{r, fig.height=4, fig.width = 6.5, warning=FALSE, message=FALSE}
abiotic %>%                        # Start with the 'abiotic' dataset
  filter(nafo_div == "2J") %>%     # Then, filter down to rows where nafo_div == 2J
  ggplot(aes(temp_bottom)) +       # Then, determine aes
    geom_histogram()               # plot histograms
```

## ggplot2: advanced stuff - tidyverse and facets {.smaller .build}

```{r, fig.height=4, fig.width = 6.5, warning=FALSE, message=FALSE}
abiotic %>%                        # Start with the 'abiotic' dataset
  filter(nafo_div == "2J") %>%     # Then, filter down to rows where nafo_div == 2J
  ggplot(aes(temp_bottom)) +       # Then, determine aes
    geom_histogram() +             # plot histograms
    facet_wrap(~ year)             # facet by year
```

## ggplot2: advanced stuff - layers  {.smaller .build}

```{r, fig.height=4, fig.width = 4, warning=FALSE}
# no layers
ggplot(data = abiotic, aes(x = temp_bottom, y = depth, colour = nafo_div)) # run this line - what happens?
```

## ggplot2: advanced stuff - layers {.smaller .build}

```{r, fig.height=4, fig.width = 4, warning=FALSE}
# one layer
ggplot(data = abiotic, aes(x = temp_bottom, y = depth, colour = nafo_div)) + # the data and aes
  geom_point()                                                               # the point layer
```

## ggplot2: advanced stuff - layers {.smaller .build}

```{r, fig.height=4, fig.width = 4, warning=FALSE}
# one layer but with data specific to layer
ggplot() +
  geom_point(data = abiotic, aes(x = temp_bottom, y = depth, colour = nafo_div))  # geom, data, aes 

```

## ggplot2: advanced stuff - layers {.smaller .build}

```{r, fig.height=4, fig.width = 4, warning=FALSE}
# two layers
ggplot() +
  geom_point(data = abiotic, aes(x = temp_bottom, y = depth, colour = nafo_div)) +
  geom_vline(aes(xintercept = 0), linetype = 2)
```

## ggplot2: advanced stuff - layers

this is not the right code
p <- ggplot (dfs.sa2, aes(x=Year, y=s, group=StudyArea, fill=StudyArea)) #data and aes

p +  geom_errorbar(position = pd, width=0.1, colour="black", aes(ymin=sLL, ymax=sUL)) + 	#plot bars
geom_point (aes(fill=StudyArea), position = pd, shape=22, size=4) + #plot points
scale_fill_manual (name = "Study Area", values=cols, breaks = c("Middle Ridge 	North", "Middle Ridge South", "La Poile", "Northern Peninsula"), 	labels=studyarea, limits=c("Middle Ridge North", "Middle Ridge South", "La 	Poile", "Northern Peninsula")) + #specify colours
ylab("Survival rate") + #label y-axis
scale_y_continuous(limits=c(0,1)) + # set limits to y-axis
theme_bw() + #change background to white
opts(legend.justification=c(1,0), legend.position=c(.25,.75)) + #position legend
ylim(0,1)  + # set limits to y-axis
opts(axis.title.x = theme_text(size=16)) + #adjust the axis title
opts(axis.title.y = theme_text(angle = 90, size=16)) + #adjust the axis title
geom_text(aes(x=Year, y=sUL+0.05, label=n.animals), size=4, position = pd)

numbers over bars

caribou graph
type: section
<div align="center">
<img src="readr_hex.png" width=500 height=500>
</div>

## ggplot2: advanced stuff - exercises

>- Using one of the trawl data sets, use pipes to modify the data and make a figure with at least two layers
>- Trying adding layers in two different ways

## ggplot2: extensions

>- multiple plots
>- interactive plots
>- maps


## ggplot2: extensions - multiple plots

```{r}


```


## ggplot2: extensions - interactive plots  {.smaller .build}

```{r, warning=FALSE, fig.height=3}
p <- abiotic %>% 
  left_join(biomass, by = c("year", "trawl_id")) %>%       # merge abiotic and biomass data
  ggplot(aes(x = depth, y = cod, colour = temp_bottom)) +  # set-up aes
  geom_point(alpha = 0.5) + scale_y_sqrt() +               # sqrt scale to help see the data
  scale_colour_viridis_c() + theme_minimal()               # set colour and theme
p                                                          # print static plot

```

## ggplot2: extensions - interactive plots {.smaller .build}

```{r, warning=FALSE, fig.width=10}
library(plotly)
ggplotly(p)       # print interactive plot
```



## ggplot2: extensions - maps  {.smaller .build}

```{r, warning=FALSE, message=FALSE}
library(sf)
strata <- read_sf("data/strata_boundaries/all_strata.shp", 
                  layer = "all_strata")                     # import shapefile
p <- abiotic %>%                                            # process abiotic data
  filter(year == 2010) %>%                                  # filter to 2010 data
  group_by(nafo_div, strata) %>%                            # set-up groups
  summarise(sets = n()) %>%                                 # calculate number of sets by strat
  left_join(strata, by = "strata") %>%                      # merge with sf object
  filter(nafo_div == "3L") %>%                              # filter to 3L
  ggplot(aes(fill = sets)) + geom_sf() +                    # start mapping
  ggtitle("Sets conducted in 2010 in 3L by strata") +       # plot title
  scale_fill_viridis_c() + theme_bw()                       # set colour and theme

```

## ggplot2: extensions - maps  {.smaller .build}

```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height = 4}
p # print map
```


## Help {.smaller}

Books on ggplot:

>- Chang, W. 2013. R Graphics Cookbook. O'Reilly
>- Wickham, H. 2009. ggplot2: elegant graphics for data analysis. Springer.

Theoretical foundation:

>- Tufte, E.R. The visual display of quantitative information.
>- Wilkinson, L. 2005. The grammar of graphics. Springer.

Websites:

>- http://www.cookbook-r.com/   [THIS IS GOLD!!!!!!!!]
>- http://ggplot.yhathq.com/
>- https://rpubs.com/hadley/ggplot2-layers [for understanding layers]

Papers:

>- Su, Y-S. 2008. It's easy to produce chartjunk using MS Excel 2007 but hard to make good graphs.  Computational Statistis and Data Anlaysis. 52: 4594-4601. https://rpubs.com/hadley/ggplot2-layers


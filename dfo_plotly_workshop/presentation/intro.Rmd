---
title: "Interactive plotting using the plotly package in R"
author: "Paul Regular"
date: "NAFC | Fisheries and Oceans Canada | Feb 15, 2018"
output:
  ioslides_presentation:
    incremental: yes
    logo: plotly_logo.png
    widescreen: yes
---


```{r setup, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
library(plotly)
knitr::opts_knit$set(root.dir = '../')
knitr::opts_chunk$set(dev = "svg")
```


## Getting started {.build .smaller}

Before we go:

1. Were you able to download the scripts and data we sent?
2. Does the following code run without errors? 

```{r startup, message=FALSE, warning=FALSE}

## Import and process data used in this presentation

# setwd("c:/where_the_folder_is/")
library(tidyverse)
library(plotly) # devtools::install_github("ropensci/plotly")
caa <- read.table("data/catch_num.txt", header = TRUE, sep = "\t", row.names = 1)
caa <- as.matrix(caa)
dimnames(caa) <- list(Year = rownames(caa), Age = gsub("X", "", colnames(caa)))
abiotic <- read_csv("data/trawl_abiotic.csv", guess_max = 5000)
biomass <- read_csv("data/trawl_biomass.csv", guess_max = 5000)
biomass <- biomass %>% left_join(abiotic, by = c("year", "trawl_id"))
cod_trend <- biomass %>% 
  group_by(year, nafo_div) %>% 
  summarise(mean_cod = mean(cod))

```

## Outline

>- What is Plotly?
>- ggplot2 recap
>- ggplot2 → plotly
>- `plot_ly` interface
>- 3D charts
>- Maps
>- Subplots
>- Controls
>- Animations
>- Help


## Plotting options

> *"The greatest value of a picture is when it forces us to notice what we never expected to see."* — John Tukey

- spreadsheets, e.g., Excel
- stand alone program, e.g., Sigma Plot
- other stats programs, e.g., SAS
- R
    - base
    - lattice
    - ggplot2
    - plotly
    
## What is plotly?

- Interface to the JavaScript graphing library that powers http://plot.ly
- You can make graphs using their online interface https://plot.ly/create/
- Or you can use the plotly package in R
- Easy to get up and running, especially if you know ggplot2

## ggplot2 recap

Grammar of graphics

- layer
    - data
    - mappings (aesthetics)
    - geometry (points, lines, polygons)
    - statistics (binning)
    - position
- scales (colour, size, shape, axes)
- coordinates (e.g. Cartesian)
- faceting (multiple subsets; lattice)

## ggplot2: scatterplot  {.build}

```{r, warning=FALSE, fig.width=10, fig.height = 4}
ggplot(data = cod_trend, aes(x = year, y = mean_cod)) + geom_point()
```


## ggplot2: more aesthetics {.build}

```{r, warning=FALSE, fig.width=10, fig.height = 4}
ggplot(data = cod_trend, aes(x = year, y = mean_cod, colour = nafo_div)) + geom_point()
```

## ggplot2: more layers {.build}

```{r, warning=FALSE, fig.width=10, fig.height = 4}
ggplot(data = cod_trend, 
       aes(x = year, y = mean_cod, colour = nafo_div, group = nafo_div)) + 
  geom_point() + geom_line()
```


## ggplot2: refine & save object {.build}

```{r, warning=FALSE}
p <- ggplot(data = cod_trend,                            # data     
            aes(x = year, y = mean_cod,                     
                colour = nafo_div, group = nafo_div)) +  # mapping (aesthetics) 
  geom_point() +                                         # points layer 
  geom_line() +                                          # lines layer
  labs(x = "Year", y = "Cod biomass (mean catch)", 
       colour = "NAFO") +                                # labels
  scale_colour_brewer(palette = "Set2") +                # colour palette
  theme_minimal()                                        # ggplot theme
```

## ggplot2: refine & save object {.build}

```{r, warning=FALSE, fig.width=10, fig.height = 4}
p # print plot
```


## ggplot2 → plotly {.build}

```{r, warning=FALSE, fig.width=10, fig.height = 4}
ggplotly(p)
```


## ggplot2 → plotly exercise {.smaller}

>- Use the `abiotic` data, `ggplot` and `ggplotly` to try and replicate the plot below

```{r echo=FALSE, warning=FALSE, fig.height=4, fig.width=10}
p <- ggplot(data = abiotic, 
            aes(x = depth, y = temp_bottom, 
                colour = temp_bottom, shape = nafo_div)) +
  scale_color_distiller(palette = "Spectral") +
  labs(x = "Depth (m)", y = "Temperature (°C)",
       colour = "Temperature (°C)", shape = "NAFO") +
  geom_point() + theme_minimal()
ggplotly(p)
```

&nbsp;

>- *Hint: use the `shape` aesthetic and a continuous colour scale (e.g. `scale_color_distiller`)*


## `plot_ly` interface

- Inspired by the layered grammar of graphics
- Not as fully featured as `ggplot` but supports some options not supported by `ggplot`
    - e.g. Can supply matrices, make 3D plots, and draw multiple axes
- Recognizes and preserves groupings created by `dplyr::group_by`
    - Facilitates a data-to-plot pipeline
- Like the `geom_` functions in ggplot2, the plotly package includes a series of `add_` functions to add layers to a plotly object

## `plot_ly`: scatterplot  {.build}

```{r, warning=FALSE, fig.width=10, fig.height = 4}
plot_ly(data = cod_trend, x = ~year, y = ~mean_cod) %>% add_markers()
```


## `plot_ly`: more aesthetics {.build}

```{r, warning=FALSE, fig.width=10, fig.height = 4}
plot_ly(data = cod_trend, x = ~year, y = ~mean_cod, color = ~nafo_div) %>% add_markers()
```

## `plot_ly`: more layers {.build}

```{r, warning=FALSE, fig.width=10, fig.height = 4}
cod_trend %>% 
  group_by(nafo_div) %>% 
  plot_ly(x = ~year, y = ~mean_cod, color = ~nafo_div) %>% 
  add_markers() %>% add_lines()
```


## `plot_ly`: refine & save object {.build}

```{r, warning=FALSE}
p <- cod_trend %>%                                          # data                                    
  group_by(nafo_div) %>%                                    # groupings
  plot_ly(x = ~year, y = ~mean_cod, color = ~nafo_div) %>%  # mapping (aesthetics)
  add_markers() %>%                                         # points layer
  add_lines() %>%                                           # lines layer
  layout(xaxis = list(title = "Year"),
         yaxis = list(title = "Cod biomass (mean catch)"))  # labels
```

## `plot_ly`: refine & save object {.build}

```{r, warning=FALSE, fig.width=10, fig.height = 4}
p # print plot
```


## `plot_ly` exercise {.smaller}

>- Use the `abiotic` data and `plot_ly` to try and replicate the plot below

```{r echo=FALSE, warning=FALSE, fig.height=4, fig.width=10}
abiotic %>% 
  group_by(nafo_div) %>% 
  plot_ly(x = ~depth, y = ~temp_bottom, 
          color = ~temp_bottom, symbol = ~nafo_div) %>% 
  add_markers() %>% 
  layout(xaxis = list(title = "Depth (m)"),
         yaxis = list(title = "Temperature (°C)")) %>% 
  colorbar(title = "Temperature (°C)")

```

>- *Hint: use the `symbol` argument in `plot_ly` and pipe `colorbar(title = "Temperature (°C)")` to label the color bar*

## 3D charts: surface {.smaller .build}

```{r, warning=FALSE, fig.width=10, fig.height = 4}
Catch <- caa[as.character(1997:2010), ]
plot_ly(x = colnames(Catch), y = rownames(Catch), z = ~Catch) %>% add_surface() %>% 
  layout(scene = list(xaxis = list(title = "Age"), 
                      yaxis = list(title = "Year"), 
                      zaxis = list(title = "Catch")))
```

## 3D charts: lines {.smaller .build}

```{r, warning=FALSE, fig.width=10, fig.height = 4}
d <- as.data.frame.table(caa[as.character(1997:2010), ], responseName = "Catch")
d$Age <- as.numeric(d$Age); d$Year <- as.numeric(d$Year)
d %>% group_by(Year) %>% 
  plot_ly(x = ~Age, y = ~Year, z = ~Catch, color = ~Catch) %>% add_lines()
```

## 3D charts: points {.smaller .build}

```{r, warning=FALSE, fig.width=10, fig.height = 4}
abiotic %>% filter(year == 2010, nafo_div == "3L") %>% 
  mutate(depth = -depth) %>% 
  plot_ly(x = ~long, y = ~lat, z = ~depth, color = ~temp_bottom) %>% 
  add_markers() %>% layout(scene = list(zaxis = list(autorange = "reversed")))
```

## Maps

```{r message=FALSE, warning=FALSE}
dat <- biomass %>% filter(year == 2010)                       # data to put on a map
base <- map_data("world", "canada") %>% group_by(group)       # base map data
p <- plot_geo(x = ~long, y = ~lat, sizes = c(1, 500)) %>%     # mapping
  add_polygons(data = base, color = I("grey"),                # add base map
               name = "base map", hoverinfo = "none") %>%     # disable tooltabs
  add_markers(data = dat, size = ~cod, name = "cod",          # add cod points
              text = ~cod) %>% 
  add_markers(data = dat, size = ~shrimp, name = "shrimp",    # add shrimp points
              text = ~shrimp) %>% 
  add_markers(data = dat, size = ~redfish, name = "redfish",  # add redfish points
              text = ~redfish) %>% 
  layout(geo = list(showframe = FALSE,                        # turn off default base map
                    showcoastlines = FALSE,
                    projection = list(type = "mercator"),     # set projection
                    lonaxis = list(range = c(-65, -40)),      # set x and y lims
                    lataxis = list(range = c(45, 56))))
```

## Map

```{r echo=FALSE, fig.height=5.5, fig.width=10, warning=FALSE}
p
```



## Help {.smaller}

Online plotly book:

>- Sievert, C. 2018. plotly for R. https://plotly-book.cpsievert.me/index.html

Websites:

>- https://plot.ly/r/   [Plotly R Library]





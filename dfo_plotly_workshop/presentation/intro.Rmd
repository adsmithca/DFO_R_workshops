---
title: "Interactive plotting using the plotly package in R"
author: "Paul Regular"
date: "NAFC | Fisheries and Oceans Canada | Feb 15, 2018"
output:
  ioslides_presentation:
    incremental: yes
    logo: plotly_logo.png
    widescreen: yes
---


```{r setup, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
library(plotly)
knitr::opts_knit$set(root.dir = '../')
knitr::opts_chunk$set(cache = TRUE)
```


## Getting started {.build .smaller}

Before we go:

1. Were you able to download the scripts and data we sent?
2. Does the following code run without errors? 

```{r startup, message=FALSE, warning=FALSE}

## Import and process data used in this presentation

# setwd("c:/where_the_folder_is/")
library(tidyverse)
library(plotly) # devtools::install_github("ropensci/plotly")
abiotic <- read_csv("data/trawl_abiotic.csv", guess_max = 5000)
biomass <- read_csv("data/trawl_biomass.csv", guess_max = 5000)
biomass <- biomass %>% left_join(abiotic, by = c("year", "trawl_id"))
cod_trend <- biomass %>% 
  group_by(year, nafo_div) %>% 
  summarise(mean_cod = mean(cod))

```

## Outline

>- What is Plotly?
>- ggplot2 recap
>- ggplot2 -> plotly
>- `plot_ly` interface
>- Just `add_` plotly
>- Subplots
>- Controls
>- Animations
>- Help


## Plotting options

> *"The greatest value of a picture is when it forces us to notice what we never expected to see."* â€” John Tukey

- spreadsheets, e.g., Excel
- stand alone program, e.g., Sigma Plot
- other stats programs, e.g., SAS
- R
    - base
    - lattice
    - ggplot2
    - plotly
    
## What is plotly?

- Interface to the JavaScript graphing library that powers http://plot.ly
- You can make graphs using their online interface https://plot.ly/create/
- Or you can use the plotly package in R
- Easy to get up and running, especially if you know ggplot2

## ggplot2 recap

Grammar of graphics

- layer
    - data
    - mappings (aesthetics)
    - geometry (points, lines, polygons)
    - statistics (binning)
    - position
- scales (colour, size, shape, axes)
- coordinates (e.g. Cartesian)
- faceting (multiple subsets; lattice)

## ggplot2: scatterplot  {.build}

```{r, warning=FALSE, fig.width=10, fig.height = 4}
ggplot(data = cod_trend, aes(x = year, y = mean_cod)) + geom_point()
```


## ggplot2: scatterplot + more aes {.build}

```{r, warning=FALSE, fig.width=10, fig.height = 4}
ggplot(data = cod_trend, aes(x = year, y = mean_cod, colour = nafo_div)) + geom_point()
```

## ggplot2: scatterplot + more layers & save object {.build}

```{r, warning=FALSE, fig.width=10, fig.height = 4}
(p <- ggplot(data = cod_trend, 
       aes(x = year, y = mean_cod, colour = nafo_div, group = nafo_div)) + 
  geom_point() + geom_line())
```


## ggplot2: refine {.build}

```{r, warning=FALSE, fig.width=10, fig.height = 4}
p + labs(x = "Year", y = "Cod biomass (mean catch)", colour = "NAFO") + 
  scale_colour_brewer(palette = "Set2") + theme_minimal()
```


<!-- ## ggplot2: advanced stuff -->

<!-- >- tidyverse & facets -->
<!-- >- working with layers - the true power of ggplot! -->

<!-- ## ggplot2: advanced stuff - the tidyverse {.smaller .build} -->

<!-- ```{r, fig.height=4, fig.width = 6.5, warning=FALSE, message=FALSE} -->
<!-- abiotic %>%                        # Start with the 'abiotic' dataset -->
<!--   filter(nafo_div == "2J") %>%     # Then, filter down to rows where nafo_div == 2J -->
<!--   ggplot(aes(temp_bottom)) +       # Then, determine aes -->
<!--     geom_histogram()               # plot histograms -->
<!-- ``` -->

<!-- ## ggplot2: advanced stuff - tidyverse and facets {.smaller .build} -->

<!-- ```{r, fig.height=4, fig.width = 6.5, warning=FALSE, message=FALSE} -->
<!-- abiotic %>%                        # Start with the 'abiotic' dataset -->
<!--   filter(nafo_div == "2J") %>%     # Then, filter down to rows where nafo_div == 2J -->
<!--   ggplot(aes(temp_bottom)) +       # Then, determine aes -->
<!--     geom_histogram() +             # plot histograms -->
<!--     facet_wrap(~ year)             # facet by year -->
<!-- ``` -->

<!-- ## ggplot2: advanced stuff - layers  {.smaller .build} -->

<!-- ```{r, fig.height=4, fig.width = 4, warning=FALSE} -->
<!-- # no layers -->
<!-- ggplot(data = abiotic, aes(x = temp_bottom, y = depth, colour = nafo_div)) # run this line - what happens? -->
<!-- ``` -->

<!-- ## ggplot2: advanced stuff - layers {.smaller .build} -->

<!-- ```{r, fig.height=4, fig.width = 4, warning=FALSE} -->
<!-- # one layer -->
<!-- ggplot(data = abiotic, aes(x = temp_bottom, y = depth, colour = nafo_div)) + # the data and aes -->
<!--   geom_point()                                                               # the point layer -->
<!-- ``` -->

<!-- ## ggplot2: advanced stuff - layers {.smaller .build} -->

<!-- ```{r, fig.height=4, fig.width = 4, warning=FALSE} -->
<!-- # one layer but with data specific to layer -->
<!-- ggplot() + -->
<!--   geom_point(data = abiotic, aes(x = temp_bottom, y = depth, colour = nafo_div))  # geom, data, aes  -->

<!-- ``` -->

<!-- ## ggplot2: advanced stuff - layers {.smaller .build} -->

<!-- ```{r, fig.height=4, fig.width = 4, warning=FALSE} -->
<!-- # two layers -->
<!-- ggplot() + -->
<!--   geom_point(data = abiotic, aes(x = temp_bottom, y = depth, colour = nafo_div)) + -->
<!--   geom_vline(aes(xintercept = 0), linetype = 2) -->
<!-- ``` -->

<!-- ## ggplot2: advanced stuff - layers {.smaller .build} -->

<!-- ```{r} -->
<!-- load("data/wdata.Rdata") -->
<!-- w <- ggplot(adf, aes(length, weight, colour = as.factor(month))) -->
<!-- w <- w + geom_point(alpha = 0.5) -->
<!-- w <- w + geom_line(data = pdata, aes(length, predw, colour = as.factor(month)), size = 1.5) -->
<!-- w <- w + labs(x = 'Length (cm)', y = 'Weight (kg)') -->
<!-- w <- w + scale_colour_discrete(name = "", -->
<!--                                breaks = c("12", "1", "2"), -->
<!--                                labels = c("December", "January", "February")) -->
<!-- ``` -->

<!-- ## ggplot2: advanced stuff - layers {.smaller .build} -->

<!-- ```{r} -->
<!-- w -->
<!-- ``` -->


<!-- ## ggplot2: advanced stuff - exercises -->

<!-- >- Using the trawl data sets, use pipes to join the two data sets, modify the data, and make a figure with at least two layers -->

<!-- ## ggplot2: extensions -->

<!-- >- multiple plots -->
<!-- >- interactive plots -->
<!-- >- maps -->


<!-- ## ggplot2: extensions - multiple plots {.smaller .build} -->
<!-- ```{r, warning=FALSE, message=FALSE} -->
<!-- p1 <- ggplot(data = abiotic, aes(x = temp_bottom, y = depth)) + geom_point() -->
<!-- p2 <- ggplot(data = abiotic, aes(x = nafo_div, y = temp_bottom)) + geom_boxplot() -->
<!-- cowplot::plot_grid(p1, p2, labels = c("A", "B")) -->
<!-- ``` -->

<!-- ## ggplot2: extensions - interactive plots {.smaller .build} -->
<!-- ```{r, warning=FALSE, message = FALSE, fig.height=3.5} -->
<!-- p <- abiotic %>%  -->
<!--   left_join(biomass, by = c("year", "trawl_id")) %>%       # merge abiotic and biomass data -->
<!--   ggplot(aes(x = depth, y = cod, colour = temp_bottom)) +  # set-up aes -->
<!--   geom_point(alpha = 0.5) + scale_y_sqrt() +               # sqrt scale to help see the data -->
<!--   scale_colour_viridis_c() + theme_minimal()               # set colour and theme -->
<!-- p                                                          # print static plot -->

<!-- ``` -->

<!-- ## ggplot2: extensions - interactive plots {.smaller .build} -->
<!-- ```{r, warning=FALSE, message=FALSE, fig.width=10} -->
<!-- library(plotly) -->
<!-- ggplotly(p)       # print interactive plot -->
<!-- ``` -->



<!-- ## ggplot2: extensions - maps  {.smaller .build} -->

<!-- ```{r, warning=FALSE, message=FALSE} -->
<!-- library(sf) -->
<!-- strata <- read_sf("data/strata_boundaries/all_strata.shp", # import shapefiles -->
<!--                   layer = "all_strata")                      -->
<!-- nl <- read_sf("data/NL_shapefile/NL.shp", layer = "NL") -->
<!-- p <- abiotic %>%  -->
<!--   left_join(biomass, by = c("year", "trawl_id")) %>%       # merge abiotic and biomass data                            -->
<!--   filter(year == 2010) %>%                                 # filter to 2010 data -->
<!--   group_by(nafo_div, strata) %>%                           # set-up groups -->
<!--   summarise(mean_shrimp = mean(shrimp)) %>%                # calculate mean biomass of shrimp by strat -->
<!--   left_join(strata, by = "strata") %>%                     # merge with sf object -->
<!--   ggplot(aes(fill = mean_shrimp)) + geom_sf() +            # strata map -->
<!--   geom_sf(data = nl, fill = "grey") +                      # NL map -->
<!--   ggtitle("Mean biomass of shrimp by strata in 2010") +    # plot labels -->
<!--   labs(fill = "Mean\nbiomass") + -->
<!--   scale_fill_viridis_c() + theme_bw()                      # colour and theme -->
<!-- ``` -->

<!-- ## ggplot2: extensions - maps  {.smaller .build} -->

<!-- ```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height = 4.5} -->
<!-- p # print map -->
<!-- ``` -->

<!-- ## Help {.smaller} -->

<!-- Books on ggplot: -->

<!-- >- Chang, W. 2013. R Graphics Cookbook. O'Reilly -->
<!-- >- Wickham, H. 2009. ggplot2: elegant graphics for data analysis. Springer. -->

<!-- Theoretical foundation: -->

<!-- >- Tufte, E.R. The visual display of quantitative information. -->
<!-- >- Wilkinson, L. 2005. The grammar of graphics. Springer. -->

<!-- Websites: -->

<!-- >- http://www.cookbook-r.com/   [THIS IS GOLD!!!!!!!!] -->
<!-- >- http://ggplot.yhathq.com/ -->
<!-- >- https://rpubs.com/hadley/ggplot2-layers [for understanding layers] -->
<!-- >- https://cran.r-project.org/web/packages/cowplot/vignettes/introduction.html -->

<!-- Papers: -->

<!-- >- Su, Y-S. 2008. It's easy to produce chartjunk using MS Excel 2007 but hard to make good graphs.  Computational Statistis and Data Anlaysis. 52: 4594-4601. https://rpubs.com/hadley/ggplot2-layers -->

